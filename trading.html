<script>
const ITEMS={"Kitsune":{"value":8000000,"img":"https://bloxfruittrading.com/static/items/kitsune.png"},"Dragon":{"value":6500000,"img":"https://bloxfruittrading.com/static/items/dragon.png"},"Leopard":{"value":5000000,"img":"https://bloxfruittrading.com/static/items/leopard.png"},"Venom":{"value":4500000,"img":"https://bloxfruittrading.com/static/items/venom.png"},"Dough":{"value":4200000,"img":"https://bloxfruittrading.com/static/items/dough.png"},"Shadow":{"value":4000000,"img":"https://bloxfruittrading.com/static/items/shadow.png"},"T-Rex":{"value":3800000,"img":"https://bloxfruittrading.com/static/items/t-rex.png"},"Mammoth":{"value":3500000,"img":"https://bloxfruittrading.com/static/items/mammoth.png"},"Control":{"value":3200000,"img":"https://bloxfruittrading.com/static/items/control.png"},"Spirit":{"value":3100000,"img":"https://bloxfruittrading.com/static/items/spirit.png"},"Blizzard":{"value":3000000,"img":"https://bloxfruittrading.com/static/items/blizzard.png"},"Gravity":{"value":2800000,"img":"https://bloxfruittrading.com/static/items/gravity.png"},"Magma":{"value":2700000,"img":"https://bloxfruittrading.com/static/items/magma.png"},"Rumble":{"value":2600000,"img":"https://bloxfruittrading.com/static/items/rumble.png"},"Phoenix":{"value":2500000,"img":"https://bloxfruittrading.com/static/items/phoenix.png"},"Buddha":{"value":2400000,"img":"https://bloxfruittrading.com/static/items/buddha.png"},"Dark":{"value":2300000,"img":"https://bloxfruittrading.com/static/items/dark.png"},"Light":{"value":2200000,"img":"https://bloxfruittrading.com/static/items/light.png"},"Ice":{"value":2100000,"img":"https://bloxfruittrading.com/static/items/ice.png"},"Flame":{"value":2000000,"img":"https://bloxfruittrading.com/static/items/flame.png"}};
const fmt=v=>((v/1000000).toFixed(v%1000000===0?0:1))+'M';

let trades = JSON.parse(localStorage.getItem('bf_trades')||'[]');
let nextId = parseInt(localStorage.getItem('bf_nextid')||'1');

function save(){localStorage.setItem('bf_trades',JSON.stringify(trades));localStorage.setItem('bf_nextid',nextId);}

function renderTrade(t){
  return `<div class="trade-card">
    <div class="trade-header"><div class="user-info"><div class="username">Guest #${t.id}</div><div class="time">just now</div></div></div>
    <div class="trade-body">
      <div class="offer"><div class="offer-title">Offering</div><div class="items">${t.offer.map(i=>`<div class="item"><div class="item-img"><img src="${i.img}"><span style="position:absolute;top:4px;left:4px;background:#7c3aed;color:#fff;padding:2px 6px;border-radius:4px;font-size:10px">R</span></div><div class="item-value">${fmt(i.value)}</div></div>`).join('')}</div></div>
      <div class="arrow">â†’</div>
      <div class="request"><div class="request-title">Requesting</div><div class="items">${t.request.map(i=>`<div class="item"><div class="item-img"><img src="${i.img}"></div><div class="item-value">${fmt(i.value)}</div></div>`).join('')}</div></div>
    </div>
  </div>`;
}

function updateUI(){
  document.getElementById('trades').innerHTML = trades.length ? trades.map(renderTrade).join('') : '<p style="text-align:center;color:#777">No trades yet</p>';
}

document.getElementById('postBtn').onclick=()=>{
  const w=window.open('','PostTrade','width=600,height=700');
  w.document.write(`<!DOCTYPE html><html><head><title>Post Trade</title>
  <style>body{background:#0f0f1a;color:#fff;font-family:Montserrat,sans-serif;padding:2rem}
  .box{max-width:600px;margin:auto;background:#11111a;padding:2rem;border-radius:1rem;border:1px solid #2a2a3a}
  select{width:100%;padding:.5rem;margin:.5rem 0;background:#000;color:#fff;border:1px solid #2a2a3a;border-radius:.5rem}
  button{background:#7c3aed;color:#fff;padding:.75rem 1.5rem;border:none;border-radius:.5rem;margin-top:1rem;cursor:pointer}</style></head>
  <body><div class="box"><h2>Post Trade</h2><form id="f">
  <h3>Offering</h3><div id="offer"></div><button type="button" onclick="add('offer')">+ Add Item</button>
  <h3>Requesting</h3><div id="request"></div><button type="button" onclick="add('request')">+ Add Item</button>
  <button type="submit">POST NOW</button></form></div>
  <script>
  const ITEMS = ${JSON.stringify(ITEMS)};
  const itemNames = Object.keys(ITEMS);
  function add(side){
    const s=document.createElement('select');
    s.innerHTML='<option value="">-- Select --</option>'+itemNames.map(n=>`<option value="${n}">${n} (${ITEMS[n].value/1e6}M)</option>`).join('');
    document.getElementById(side).appendChild(s);
  }
  document.getElementById('f').onsubmit=e=>{
    e.preventDefault();
    const offer=[], request=[];
    document.querySelectorAll('#offer select').forEach(s=>{if(s.value)offer.push(ITEMS[s.value]);});
    document.querySelectorAll('#request select').forEach(s=>{if(s.value)request.push(ITEMS[s.value]);});
    if(offer.length===0 || request.length===0){alert('Add at least one item each side');return;}
    window.opener.postMessage({type:'newtrade',offer,request},'*');
    document.body.innerHTML='<h2 style="text-align:center;color:#7c3aed">Posted! Closing...</h2>';
    setTimeout(()=>window.close(),1500);
  };
  add('offer'); add('request');
  </script></body></html>`);
};

window.addEventListener('message',e=>{
  if(e.data.type==='newtrade'){
    trades.unshift({id:nextId++,offer:e.data.offer,request:e.data.request});
    save();
    updateUI();
  }
});

updateUI();
</script>
